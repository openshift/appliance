#!/usr/bin/env bash

ISO_DIR=/run/media/iso
MNT_DIR=/mnt/agentdata

create_data_device() {
    # Create a loop device for each data file part
    DATA_FILES="$ISO_DIR/data/data*"
    loop_sizes=()
    for f in $DATA_FILES
    do
        device=$(losetup --find)
        losetup $device $f
        loop_sizes+=($device)
    done

    # Create a device map using the loop devices
    (
        start=0
        for device in "${loop_sizes[@]}"
        do
            size=`blockdev --getsz $device`
            echo "$start $size linear $device 0"
            ((start+=$size))
        done
    ) | dmsetup create data
}

wait_for_iso_mount() {
    while ! mountpoint -q $ISO_DIR; do
        echo "Waiting for $ISO_DIR to be fully mounted..."
        sleep 5
    done
}

mount_registry_data_iso() {
    registry_data_iso=/home/core/registry_data.iso

    # If the registry data iso does not exist, create it
    if [ ! -f "$registry_data_iso" ]; then
        # Wait for the mount to be ready
        wait_for_iso_mount

        # Create the registry data iso
        cat $ISO_DIR/data/data* > $registry_data_iso
    fi

    # Mount the registry data iso
    mount -o ro $registry_data_iso $MNT_DIR
}

mkdir -p $MNT_DIR

if [ "{{.IsLiveISO}}" = "true" ]; then
    if [ "{{.IsBootstrapStep}}" = "true" ]; then
        # Wait for the mount to be ready
        wait_for_iso_mount

        # Create virtual device for the registry data
        create_data_device

        # Mount data iso
        mount -o ro /dev/dm-0 $MNT_DIR
    else
        # Mount the registry data iso
        mount_registry_data_iso
    fi
else # Disk image mode
    # Mount agentdata partition
    mount -o ro /dev/disk/by-partlabel/agentdata $MNT_DIR
fi
